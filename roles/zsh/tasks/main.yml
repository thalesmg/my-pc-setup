---

- name: installs zsh
  package:
    name: zsh
    state: present
  register: zsh_installed

- name: set zsh as the default shell
  become: yes
  become_user: root
  when: zsh_installed.changed
  command: "chsh -s /usr/bin/zsh {{ my_user }}"

- name: checks that oh my zsh is installed
  become: yes
  become_user: "{{ my_user }}"
  stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: ohmyzsh
  changed_when: not ohmyzsh.stat.exists

- block:
    - name: install oh my zsh
      become: yes
      become_user: "{{ my_user }}"
      register: ohmyzsh_install
      shell: sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"

    - name: install bullettrain theme for oh my zsh
      become: yes
      become_user: "{{ my_user }}"
      when: ohmyzsh_install is changed or zsh_install | default(False)
      get_url:
        url: "http://raw.github.com/caiogondim/bullet-train-oh-my-zsh-theme/master/bullet-train.zsh-theme"
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/bullet-train.zsh-theme"

    - name: config .zshrc
      become: yes
      become_user: "{{ my_user }}"
      when: ohmyzsh_install is changed or zsh_install | default(False)
      template:
        src: .zshrc.j2
        dest: "{{ ansible_env.HOME }}/.zshrc"

- name: copy .profile
  template:
    src: .profile
    dest: "{{ home }}/.profile"
    mode: 0700

- name: copy .profile
  template:
    src: xmodmap
    dest: "{{ home }}/.xmodmap"
    mode: 0700

- name: bullet-train exit code
  lineinfile:
    regexp: '^( *)BULLETTRAIN_STATUS_EXIT_SHOW=false$'
    line: '\1BULLETTRAIN_STATUS_EXIT_SHOW=true'
    backrefs: true
    path: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/bullet-train.zsh-theme"

- name: bullet-train prompt char
  lineinfile:
    regexp: '^( *)BULLETTRAIN_PROMPT_CHAR'
    line: '\1BULLETTRAIN_PROMPT_CHAR="Í³ "'
    backrefs: true
    path: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/themes/bullet-train.zsh-theme"

...
