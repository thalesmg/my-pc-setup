---

- name: installs zsh
  package:
    name: zsh
    state: present
  register: zsh_installed

- name: set zsh as the default shell
  become: yes
  become_user: root
  when: zsh_installed.changed
  command: "chsh -s /usr/bin/zsh {{ my_user }}"

- name: checks that oh my zsh is installed
  become: yes
  become_user: "{{ my_user }}"
  stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: ohmyzsh
  changed_when: not ohmyzsh.stat.exists

- name: install oh my zsh
  become: yes
  become_user: "{{ my_user }}"
  when: ohmyzsh.changed
  register: ohmyzsh_install
  command: |
    curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh | sh -c

- name: install bullettrain theme for oh my zsh
  when: ohmyzsh_install.changed
  become: yes
  become_user: "{{ my_user }}"
  get_url:
    src: "http://raw.github.com/caiogondim/bullet-train-oh-my-zsh-theme/master/bullet-train.zsh-theme"
    dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/"

- name: config .zshrc
  become: yes
  become_user: "{{ my_user }}"
  when: ohmyzsh_install.changed
  template:
    src: .zshrc.j2
    dest: "{{ ansible_env.HOME }}/.zshrc"

- name: Configure .xprofile
  lineinfile:
    path: "{{ ansible_env.HOME }}/.xprofile"
    regexp: "^xset r rate"
    line: "xset r rate 240 42"
    create: yes

...
